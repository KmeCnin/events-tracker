<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>Event Tracker PWA</title>
    
    <link rel="manifest" href="manifest.json">
    <link rel="icon" href="favicon.svg" type="image/svg+xml">
    <meta name="theme-color" content="#4CAF50"/>
    <meta name="apple-mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
    <meta name="apple-mobile-web-app-title" content="Event Tracker">
    <link rel="apple-touch-icon" href="icon-192x192.png">

    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://unpkg.com/react@18/umd/react.development.js"></script>
    <script src="https://unpkg.com/react-dom@18/umd/react-dom.development.js"></script>
    <script src="https://unpkg.com/@babel/standalone/babel.min.js"></script>
    <!-- Added Chart.js for the new chart view -->
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/chartjs-adapter-date-fns/dist/chartjs-adapter-date-fns.bundle.min.js"></script>


    <style>
        body { font-family: 'Inter', sans-serif; }
        @import url('https://fonts.googleapis.com/css2?family=Inter:wght@400;600;700&display=swap');
        
        .calendar-grid { display: grid; grid-template-columns: repeat(7, 1fr); gap: 4px; }
        .calendar-day { aspect-ratio: 1 / 1; transition: background-color 0.2s, transform 0.2s; }
        .calendar-day:hover { background-color: #e0f2f1; transform: scale(1.1); z-index: 10; }
        .calendar-day-header { font-size: 0.75rem; color: #6b7280; }
        .marked-day { background-color: #4CAF50; color: white; border-radius: 50%; }
        .tooltip {
            position: absolute;
            transform: translate(-50%, -100%);
            padding: 8px 12px;
            background-color: #333;
            color: white;
            border-radius: 6px;
            font-size: 0.875rem;
            pointer-events: none;
            z-index: 100;
            white-space: nowrap;
        }
        .toast {
            position: fixed;
            bottom: 20px;
            left: 50%;
            transform: translateX(-50%);
            padding: 12px 20px;
            background-color: #2d3748;
            color: white;
            border-radius: 8px;
            z-index: 1000;
            opacity: 0;
            transition: opacity 0.5s, bottom 0.5s;
        }
        .toast.show {
            opacity: 1;
            bottom: 40px;
        }
    </style>
</head>
<body class="bg-gray-100">
    <div id="root"></div>

    <script type="text/babel">
        const { useState, useEffect, useCallback, useMemo, useRef } = React;

        // --- Helpers ---
        const DB_KEY = 'eventTrackerData';

        const formatRelativeTime = (timestamp, isFuture = false) => {
            const now = new Date();
            const targetDate = new Date(timestamp);
            const seconds = Math.floor((targetDate - now) / 1000);
            const absSeconds = Math.abs(seconds);

            if (absSeconds < 2) return isFuture ? "soon" : "just now";
            if (absSeconds < 60) return `${absSeconds} seconds ${isFuture ? 'from now' : 'ago'}`;
            
            const minutes = Math.floor(absSeconds / 60);
            if (minutes < 60) return `${minutes} minute${minutes > 1 ? 's' : ''} ${isFuture ? 'from now' : 'ago'}`;

            const hours = Math.floor(minutes / 60);
            if (hours < 24) return `${hours} hour${hours > 1 ? 's' : ''} ${isFuture ? 'from now' : 'ago'}`;

            const days = Math.floor(hours / 24);
            if (days < 7) {
                if (days === 1) return isFuture ? "tomorrow" : "yesterday";
                return `${days} days ${isFuture ? 'from now' : 'ago'}`;
            }

            const weeks = Math.floor(days / 7);
            if (weeks < 5) return `${weeks} week${weeks > 1 ? 's' : ''} ${isFuture ? 'from now' : 'ago'}`;

            const months = Math.floor(days / 30.44);
            if (months < 12) return `${months} month${months > 1 ? 's' : ''} ${isFuture ? 'from now' : 'ago'}`;

            const years = Math.floor(days / 365.25);
            return `${years} year${years > 1 ? 's' : ''} ${isFuture ? 'from now' : 'ago'}`;
        };

        const generateFakeData = () => {
            const eventName = "Test";
            const event = { id: Date.now(), name: eventName };
            const increments = [];

            const now = Date.now();
            let currentTime = now - (365 * 24 * 60 * 60 * 1000); // Start 1 year ago

            const meanInterval = 3 * 24 * 60 * 60 * 1000; // 3 days in ms
            const randomness = 30 * 60 * 60 * 1000; // 30 hours in ms

            for (let i = 0; i < 129; i++) {
                currentTime += meanInterval;
                const randomOffset = (Math.random() * 2 - 1) * randomness;
                const triggerTime = currentTime + randomOffset;
                if (triggerTime > now) break;
                increments.push({ id: Date.now() + i, timestamp: triggerTime });
            }

            return {
                events: [event],
                increments: { [event.id]: increments }
            };
        };
        
        const getInitialData = () => {
            try {
                const data = localStorage.getItem(DB_KEY);
                const parsed = data ? JSON.parse(data) : null;
                if (parsed && Array.isArray(parsed.events) && parsed.events.length > 0) {
                    return parsed;
                }
            } catch (error) {
                console.error("Failed to parse data from localStorage", error);
            }
            return generateFakeData();
        };

        const saveData = (data) => localStorage.setItem(DB_KEY, JSON.stringify(data));

        // --- Main App Component ---
        const App = () => {
            const [data, setData] = useState(getInitialData);
            const [route, setRoute] = useState(window.location.hash);
            const [newEventName, setNewEventName] = useState('');
            const [toastMessage, setToastMessage] = useState('');
            const [importModalOpen, setImportModalOpen] = useState(false);

            useEffect(() => {
                const handleHashChange = () => setRoute(window.location.hash);
                window.addEventListener('hashchange', handleHashChange);
                return () => window.removeEventListener('hashchange', handleHashChange);
            }, []);

            useEffect(() => {
                const urlParams = new URLSearchParams(window.location.search);
                const action = urlParams.get('action');
                const eventId = parseInt(urlParams.get('event'), 10);

                if (action === 'increment' && eventId) {
                    setData(prevData => {
                        const incrementsForEvent = prevData.increments[eventId] || [];
                        const newIncrements = [...incrementsForEvent, { id: Date.now(), timestamp: Date.now() }];
                        const newData = {
                            ...prevData,
                            increments: { ...prevData.increments, [eventId]: newIncrements }
                        };
                        saveData(newData);
                        return newData;
                    });
                    window.history.replaceState({}, document.title, window.location.pathname);
                }
            }, []);

            useEffect(() => { saveData(data); }, [data]);
            
            useEffect(() => {
                if (toastMessage) {
                    const timer = setTimeout(() => setToastMessage(''), 3000);
                    return () => clearTimeout(timer);
                }
            }, [toastMessage]);

            const handleAddEvent = () => {
                if (newEventName.trim()) {
                    const newEvent = { id: Date.now(), name: newEventName.trim() };
                    setData(prev => ({
                        ...prev,
                        events: [...prev.events, newEvent],
                        increments: { ...prev.increments, [newEvent.id]: [] }
                    }));
                    setNewEventName('');
                }
            };
            
            const handleImport = (csvContent) => {
                const lines = csvContent.split('\n').filter(line => line.trim() !== '');
                if (lines.length < 2) {
                    setToastMessage("Import failed: CSV is empty or has no data.");
                    return;
                }

                const header = lines[0].trim().toLowerCase();
                if (header !== 'event,timestampiso') {
                    setToastMessage("Import failed: Invalid CSV header. Expected 'Event,TimestampISO'.");
                    return;
                }

                const firstLine = lines[1].trim();
                const firstCommaIndex = firstLine.indexOf(',');
                let baseEventName = firstLine.substring(0, firstCommaIndex);
                if (baseEventName.startsWith('"') && baseEventName.endsWith('"')) {
                    baseEventName = baseEventName.slice(1, -1).replace(/""/g, '"');
                }
                
                let finalEventName = baseEventName;
                let version = 2;
                
                while (data.events.some(event => event.name === finalEventName)) {
                    finalEventName = `${baseEventName} (v${version})`;
                    version++;
                }

                const newEvent = { id: Date.now(), name: finalEventName };
                const newIncrements = [];

                for (let i = 1; i < lines.length; i++) {
                    const line = lines[i].trim();
                    const lastCommaIndex = line.lastIndexOf(',');
                    if (lastCommaIndex > -1) {
                        const isoTimestamp = line.substring(lastCommaIndex + 1);
                        const timestamp = new Date(isoTimestamp).getTime();
                        if (!isNaN(timestamp)) {
                            newIncrements.push({ id: Date.now() + i, timestamp });
                        }
                    }
                }
                
                setData(prev => ({
                    ...prev,
                    events: [...prev.events, newEvent],
                    increments: { ...prev.increments, [newEvent.id]: newIncrements }
                }));

                setToastMessage(`Successfully imported "${finalEventName}" with ${newIncrements.length} entries.`);
                setImportModalOpen(false);
            };

            const handleGenerateTestData = () => {
                setData(prevData => {
                    const testData = generateFakeData();
                    let baseEventName = testData.events[0].name; // "Test"
                    const newTestIncrements = testData.increments[testData.events[0].id];

                    let finalEventName = baseEventName;
                    let version = 2;
                    while (prevData.events.some(event => event.name === finalEventName)) {
                        finalEventName = `${baseEventName} (v${version})`;
                        version++;
                    }
                    
                    const newTestEvent = { id: Date.now(), name: finalEventName };

                    return {
                        ...prevData,
                        events: [...prevData.events, newTestEvent],
                        increments: {
                            ...prevData.increments,
                            [newTestEvent.id]: newTestIncrements
                        }
                    };
                });
                setToastMessage("New test event has been generated.");
            };

            const updateEventData = (eventId, newIncrements) => {
                setData(prev => ({
                    ...prev,
                    increments: { ...prev.increments, [eventId]: newIncrements }
                }));
            };

            const handleUpdateEventName = (eventId, newName) => {
                setData(prevData => {
                    const newEvents = prevData.events.map(event => {
                        if (event.id === eventId) {
                            return { ...event, name: newName };
                        }
                        return event;
                    });
                    return { ...prevData, events: newEvents };
                });
            };

            const handleMoveEvent = (index, direction) => {
                setData(prevData => {
                    const newEvents = [...prevData.events];
                    const targetIndex = direction === 'up' ? index - 1 : index + 1;
                    if (targetIndex < 0 || targetIndex >= newEvents.length) {
                        return prevData; // Out of bounds
                    }
                    // Swap elements
                    [newEvents[index], newEvents[targetIndex]] = [newEvents[targetIndex], newEvents[index]];
                    return { ...prevData, events: newEvents };
                });
            };

            const deleteEvent = (eventId) => {
                setData(prev => {
                    const newEvents = prev.events.filter(e => e.id !== eventId);
                    const newIncrements = { ...prev.increments };
                    delete newIncrements[eventId];
                    return { events: newEvents, increments: newIncrements };
                });
                window.location.hash = '';
            };

            let currentView;
            const routeParts = route.replace(/^#\/?|\/$/g, '').split('/');
            
            if (routeParts[0] === 'event' && routeParts[1]) {
                const eventId = parseInt(routeParts[1], 10);
                const selectedEvent = data.events.find(e => e.id === eventId);
                if (selectedEvent) {
                    currentView = (
                        <EventDetail
                            event={selectedEvent}
                            increments={data.increments[selectedEvent.id] || []}
                            onUpdate={(newIncrements) => updateEventData(selectedEvent.id, newIncrements)}
                            onUpdateName={(newName) => handleUpdateEventName(selectedEvent.id, newName)}
                            onDelete={() => deleteEvent(selectedEvent.id)}
                            onBack={() => window.location.hash = ''}
                            setToast={setToastMessage}
                        />
                    );
                } else {
                    window.location.hash = '';
                }
            } else {
                currentView = (
                    <div>
                        <header className="mb-6 flex justify-between items-center">
                            <div>
                                <h1 className="text-4xl font-bold text-gray-800">Event Tracker</h1>
                                <p className="text-gray-500">A simple PWA to track your habits.</p>
                            </div>
                            <div className="flex gap-2">
                                <button onClick={handleGenerateTestData} className="bg-gray-500 text-white px-4 py-2 rounded-lg font-semibold hover:bg-gray-600">Test</button>
                                <button onClick={() => setImportModalOpen(true)} className="bg-indigo-500 text-white px-4 py-2 rounded-lg font-semibold hover:bg-indigo-600">Import</button>
                            </div>
                        </header>
                        <form onSubmit={(e) => { e.preventDefault(); handleAddEvent(); }} className="flex gap-2 mb-6">
                            <input
                                type="text" value={newEventName} onChange={(e) => setNewEventName(e.target.value)}
                                placeholder="Add a new event..."
                                className="flex-grow p-3 border rounded-lg focus:ring-2 focus:ring-green-500 focus:outline-none"
                            />
                            <button type="submit" className="bg-green-500 text-white px-6 py-3 rounded-lg font-semibold hover:bg-green-600 transition-colors">Add</button>
                        </form>
                        {data.events.length > 0 ? (
                            <div className="space-y-4">
                                {data.events.map((event, index) => (
                                    <EventCard
                                        key={event.id}
                                        event={event}
                                        increments={data.increments[event.id] || []}
                                        onUpdate={(newIncrements) => updateEventData(event.id, newIncrements)}
                                        onSelect={() => window.location.hash = `/event/${event.id}`}
                                        onMove={handleMoveEvent}
                                        index={index}
                                        totalEvents={data.events.length}
                                    />
                                ))}
                            </div>
                        ) : (
                            <div className="text-center py-10 px-6 bg-white rounded-lg shadow"><p className="text-gray-500">No events yet. Add one to get started!</p></div>
                        )}
                    </div>
                );
            }

            return (
                <div className="max-w-4xl mx-auto p-4 md:p-6">
                    {currentView}
                    <div className={`toast ${toastMessage ? 'show' : ''}`}>{toastMessage}</div>
                    {importModalOpen && <ImportModal onClose={() => setImportModalOpen(false)} onImport={handleImport} />}
                </div>
            );
        };

        // --- Child Components ---

        const EventCard = ({ event, increments, onUpdate, onSelect, onMove, index, totalEvents }) => {
            const handleIncrement = (e) => {
                e.stopPropagation();
                onUpdate([...increments, { id: Date.now(), timestamp: Date.now() }]);
            };
            
            const { startDate, lastTriggerDate } = useMemo(() => {
                if (!increments || increments.length === 0) return { startDate: null, lastTriggerDate: null };
                const timestamps = increments.map(inc => inc.timestamp);
                const firstTimestamp = Math.min(...timestamps);
                const lastTimestamp = Math.max(...timestamps);
                return {
                    startDate: {
                        date: new Date(firstTimestamp).toLocaleDateString(),
                        relative: formatRelativeTime(firstTimestamp)
                    },
                    lastTriggerDate: {
                        date: new Date(lastTimestamp).toLocaleDateString(),
                        relative: formatRelativeTime(lastTimestamp)
                    }
                };
            }, [increments]);

            return (
                <div onClick={onSelect} className="bg-white p-4 rounded-lg shadow-md flex items-center cursor-pointer hover:shadow-lg transition-shadow">
                    <div className="flex flex-col gap-1 mr-4">
                        <button onClick={(e) => { e.stopPropagation(); onMove(index, 'up'); }} disabled={index === 0} className="disabled:opacity-20 disabled:cursor-not-allowed">
                            <svg className="w-6 h-6" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path strokeLinecap="round" strokeLinejoin="round" strokeWidth="2" d="M5 15l7-7 7 7"></path></svg>
                        </button>
                        <button onClick={(e) => { e.stopPropagation(); onMove(index, 'down'); }} disabled={index === totalEvents - 1} className="disabled:opacity-20 disabled:cursor-not-allowed">
                            <svg className="w-6 h-6" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path strokeLinecap="round" strokeLinejoin="round" strokeWidth="2" d="M19 9l-7 7-7-7"></path></svg>
                        </button>
                    </div>
                    <div className="flex-grow">
                        <h2 className="text-xl font-semibold text-gray-700">{event.name}</h2>
                        <div className="text-xs text-gray-500 mt-1 space-y-1">
                            {startDate && (
                                <p>Since: <span className="font-semibold">{startDate.date}</span> ({startDate.relative})</p>
                            )}
                            {lastTriggerDate && (
                                <p>Last: <span className="font-semibold">{lastTriggerDate.date}</span> ({lastTriggerDate.relative})</p>
                            )}
                        </div>
                        <p className="text-3xl font-bold text-green-600 mt-2">{increments.length}</p>
                    </div>
                    <div className="flex items-center gap-3 pl-4">
                        <button onClick={handleIncrement} className="bg-green-500 text-white w-20 h-20 rounded-full flex items-center justify-center text-4xl font-bold hover:bg-green-600 transition-colors flex-shrink-0">+</button>
                    </div>
                </div>
            );
        };
        
        const useEventStats = (increments) => {
            return useMemo(() => {
                if (!increments || increments.length === 0) {
                    return { stats: { total: 0, avgPerMonth: 0, avgTimeBetween: 'N/A' }, startDate: null, lastTriggerDate: null, nextEstimatedTrigger: null };
                }

                const sorted = [...increments].sort((a, b) => a.timestamp - b.timestamp);
                const firstTimestamp = sorted[0].timestamp;
                const lastTimestamp = sorted[sorted.length - 1].timestamp;

                const sDate = {
                    date: new Date(firstTimestamp).toLocaleDateString(),
                    relative: formatRelativeTime(firstTimestamp)
                };
                const lDate = {
                    date: new Date(lastTimestamp).toLocaleDateString(),
                    relative: formatRelativeTime(lastTimestamp)
                };

                let avgPerMonth = 0;
                let avgTimeBetween = 'N/A';
                let avgDiffMs = 0;
                let nextEstTrigger = null;

                if (sorted.length >= 2) {
                    const months = new Set();
                    sorted.forEach(inc => {
                        const d = new Date(inc.timestamp);
                        months.add(`${d.getFullYear()}-${d.getMonth()}`);
                    });
                    avgPerMonth = months.size > 0 ? (sorted.length / months.size).toFixed(1) : 0;

                    let totalDiff = 0;
                    for (let i = 1; i < sorted.length; i++) {
                        totalDiff += sorted[i].timestamp - sorted[i-1].timestamp;
                    }
                    avgDiffMs = totalDiff / (sorted.length - 1);
                    
                    const days = Math.floor(avgDiffMs / (1000 * 60 * 60 * 24));
                    const hours = Math.floor((avgDiffMs % (1000 * 60 * 60 * 24)) / (1000 * 60 * 60));
                    avgTimeBetween = `${days}d ${hours}h`;
                    
                    const nextTimestamp = lastTimestamp + avgDiffMs;
                    nextEstTrigger = {
                        date: new Date(nextTimestamp).toLocaleDateString(),
                        relative: formatRelativeTime(nextTimestamp, true)
                    };
                }

                return {
                    stats: { total: sorted.length, avgPerMonth, avgTimeBetween },
                    startDate: sDate,
                    lastTriggerDate: lDate,
                    nextEstimatedTrigger: nextEstTrigger
                };
            }, [increments]);
        };

        const Statistics = ({ stats }) => {
            return (
                <div className="grid grid-cols-3 gap-2 mb-6 text-center">
                    <div className="bg-green-100 p-2 rounded-lg"><div className="text-xl font-bold text-green-800">{stats.total}</div><div className="text-xs text-green-600">Total</div></div>
                    <div className="bg-blue-100 p-2 rounded-lg"><div className="text-xl font-bold text-blue-800">{stats.avgPerMonth}</div><div className="text-xs text-blue-600">Avg/Month</div></div>
                    <div className="bg-yellow-100 p-2 rounded-lg"><div className="text-xl font-bold text-yellow-800">{stats.avgTimeBetween}</div><div className="text-xs text-yellow-600">Avg Between</div></div>
                </div>
            );
        };

        const EventDetail = ({ event, increments, onUpdate, onUpdateName, onDelete, onBack, setToast }) => {
            const [activeView, setActiveView] = useState('calendar');
            const [confirmModal, setConfirmModal] = useState({ isOpen: false, title: '', message: '', onConfirm: null });
            const [exportModalOpen, setExportModalOpen] = useState(false);
            const [editModalOpen, setEditModalOpen] = useState(false);
            const [editIncrementModal, setEditIncrementModal] = useState({ isOpen: false, increment: null });
            const [menuOpen, setMenuOpen] = useState(false);
            const menuRef = useRef(null);

            const { stats, startDate, lastTriggerDate, nextEstimatedTrigger } = useEventStats(increments);

            useEffect(() => {
                const handleClickOutside = (event) => {
                    if (menuRef.current && !menuRef.current.contains(event.target)) {
                        setMenuOpen(false);
                    }
                };
                document.addEventListener("mousedown", handleClickOutside);
                return () => document.removeEventListener("mousedown", handleClickOutside);
            }, [menuRef]);

            const handleDayUpdate = (date, newDayIncrements) => {
                const startOfDay = new Date(date.getFullYear(), date.getMonth(), date.getDate()).getTime();
                const endOfDay = startOfDay + 24 * 60 * 60 * 1000 -1;
                const otherIncrements = increments.filter(inc => inc.timestamp < startOfDay || inc.timestamp > endOfDay);
                onUpdate([...otherIncrements, ...newDayIncrements]);
            };
            
            const handleIncrementUpdate = (updatedIncrement) => {
                const newIncrements = increments.map(inc => 
                    inc.id === updatedIncrement.id ? updatedIncrement : inc
                );
                onUpdate(newIncrements);
            };

            const requestEventDelete = () => {
                setConfirmModal({
                    isOpen: true,
                    title: 'Delete Event',
                    message: `Are you sure you want to permanently delete "${event.name}" and all its data? This action cannot be undone.`,
                    onConfirm: () => onDelete()
                });
            };

            const requestIncrementDelete = (incrementToDelete) => {
                setConfirmModal({
                    isOpen: true,
                    title: 'Delete Entry',
                    message: `Are you sure you want to delete the entry from ${new Date(incrementToDelete.timestamp).toLocaleString()}?`,
                    onConfirm: () => {
                        const newIncrements = increments.filter(inc => inc.id !== incrementToDelete.id);
                        onUpdate(newIncrements);
                    }
                });
            };

            return (
                <div className="bg-white p-6 rounded-lg shadow-lg">
                    <div className="flex justify-between items-center mb-4">
                        <a href="#" onClick={onBack} className="text-green-600 hover:underline">&larr; Back</a>
                        <div className="relative" ref={menuRef}>
                            <button onClick={() => setMenuOpen(!menuOpen)} className="p-2 rounded-full hover:bg-gray-200">
                                <svg className="w-6 h-6 text-gray-600" fill="currentColor" viewBox="0 0 20 20"><path d="M10 6a2 2 0 110-4 2 2 0 010 4zM10 12a2 2 0 110-4 2 2 0 010 4zM10 18a2 2 0 110-4 2 2 0 010 4z"></path></svg>
                            </button>
                            {menuOpen && (
                                <div className="absolute right-0 mt-2 w-48 bg-white rounded-md shadow-lg z-20 border">
                                    <a href="#" onClick={(e) => { e.preventDefault(); setEditModalOpen(true); setMenuOpen(false); }} className="block px-4 py-2 text-sm text-gray-700 hover:bg-gray-100">Edit Name</a>
                                    <a href="#" onClick={(e) => { e.preventDefault(); setExportModalOpen(true); setMenuOpen(false); }} className="block px-4 py-2 text-sm text-gray-700 hover:bg-gray-100">Export</a>
                                    <a href="#" onClick={(e) => { e.preventDefault(); requestEventDelete(); setMenuOpen(false); }} className="block px-4 py-2 text-sm text-red-700 hover:bg-red-100">Delete Event</a>
                                </div>
                            )}
                        </div>
                    </div>
                    <h1 className="text-4xl font-bold text-gray-800">{event.name}</h1>
                    <div className="text-sm text-gray-500 mb-4 space-y-1 mt-2">
                        {startDate && (
                            <p>Tracking since: <span className="font-semibold">{startDate.date}</span> ({startDate.relative})</p>
                        )}
                        {lastTriggerDate && (
                            <p>Last trigger: <span className="font-semibold">{lastTriggerDate.date}</span> ({lastTriggerDate.relative})</p>
                        )}
                         {nextEstimatedTrigger && (
                            <p>Next estimated: <span className="font-semibold">{nextEstimatedTrigger.date}</span> ({nextEstimatedTrigger.relative})</p>
                        )}
                    </div>
                    
                    <Statistics stats={stats} />

                    <div className="flex justify-center gap-2 p-1 bg-gray-200 rounded-lg mb-4">
                        {['chart', 'calendar', 'list'].map(view => (
                            <button key={view} onClick={() => setActiveView(view)} className={`flex-1 px-4 py-2 rounded-md font-semibold capitalize transition-colors ${activeView === view ? 'bg-white shadow' : 'bg-transparent text-gray-600 hover:bg-gray-300'}`}>
                                {view}
                            </button>
                        ))}
                    </div>
                    
                    {activeView === 'chart' && <ChartView increments={increments} />}
                    {activeView === 'calendar' && <CalendarView increments={increments} onDayUpdate={handleDayUpdate} />}
                    {activeView === 'list' && <ListView increments={increments} onIncrementDeleteRequest={requestIncrementDelete} onIncrementEditRequest={(inc) => setEditIncrementModal({isOpen: true, increment: inc})} />}
                    
                    {confirmModal.isOpen && (
                        <ConfirmationModal
                            title={confirmModal.title}
                            message={confirmModal.message}
                            onConfirm={() => {
                                confirmModal.onConfirm();
                                setConfirmModal({ isOpen: false, title: '', message: '', onConfirm: null });
                            }}
                            onCancel={() => setConfirmModal({ isOpen: false, title: '', message: '', onConfirm: null })}
                        />
                    )}
                    {exportModalOpen && (
                        <ExportModal
                            event={event}
                            increments={increments}
                            onClose={() => setExportModalOpen(false)}
                            setToast={setToast}
                        />
                    )}
                    {editModalOpen && (
                        <EditNameModal
                            currentName={event.name}
                            onClose={() => setEditModalOpen(false)}
                            onSave={(newName) => {
                                onUpdateName(newName);
                                setEditModalOpen(false);
                                setToast("Event name updated.");
                            }}
                        />
                    )}
                    {editIncrementModal.isOpen && (
                        <EditIncrementModal
                            increment={editIncrementModal.increment}
                            onClose={() => setEditIncrementModal({isOpen: false, increment: null})}
                            onSave={(updatedIncrement) => {
                                handleIncrementUpdate(updatedIncrement);
                                setEditIncrementModal({isOpen: false, increment: null});
                                setToast("Trigger updated.");
                            }}
                        />
                    )}
                </div>
            );
        };
        
        const ChartView = ({ increments }) => {
            const chartRef = useRef(null);
            const chartInstance = useRef(null);
            const [groupBy, setGroupBy] = useState('week'); // 'day', 'week', 'month', 'year'

            useEffect(() => {
                if (!chartRef.current || increments.length === 0) return;

                const getGroupKey = (timestamp, unit) => {
                    const d = new Date(timestamp);
                    if (unit === 'day') return new Date(d.getFullYear(), d.getMonth(), d.getDate()).toISOString().split('T')[0];
                    if (unit === 'month') return `${d.getFullYear()}-${String(d.getMonth() + 1).padStart(2, '0')}`;
                    if (unit === 'year') return d.getFullYear().toString();
                    // week
                    const dCopy = new Date(d.valueOf());
                    const dayNum = (d.getDay() + 6) % 7;
                    dCopy.setDate(dCopy.getDate() - dayNum + 3);
                    const firstThursday = dCopy.valueOf();
                    dCopy.setMonth(0, 1);
                    if (dCopy.getDay() !== 4) {
                        dCopy.setMonth(0, 1 + ((4 - dCopy.getDay()) + 7) % 7);
                    }
                    const weekNumber = 1 + Math.ceil((firstThursday - dCopy) / 604800000);
                    return `${d.getFullYear()}-W${String(weekNumber).padStart(2, '0')}`;
                };

                const dataByGroup = increments.reduce((acc, inc) => {
                    const key = getGroupKey(inc.timestamp, groupBy);
                    acc[key] = (acc[key] || 0) + 1;
                    return acc;
                }, {});

                const sortedKeys = Object.keys(dataByGroup).sort();
                const labels = sortedKeys;
                const data = sortedKeys.map(key => dataByGroup[key]);

                if (chartInstance.current) {
                    chartInstance.current.destroy();
                }

                chartInstance.current = new Chart(chartRef.current, {
                    type: 'bar',
                    data: {
                        labels: labels,
                        datasets: [{
                            label: `Triggers per ${groupBy}`,
                            data: data,
                            backgroundColor: 'rgba(76, 175, 80, 0.5)',
                            borderColor: 'rgba(76, 175, 80, 1)',
                            borderWidth: 1
                        }]
                    },
                    options: {
                        scales: {
                            y: { beginAtZero: true, ticks: { stepSize: 1 } },
                            x: { type: 'category' }
                        },
                        plugins: {
                            tooltip: {
                                callbacks: {
                                    title: (context) => `Count: ${context[0].formattedValue}`
                                }
                            }
                        }
                    }
                });

                return () => chartInstance.current?.destroy();
            }, [increments, groupBy]);

            return (
                <div>
                    <div className="flex justify-center gap-2 mb-4">
                        {['day', 'week', 'month', 'year'].map(unit => (
                            <button key={unit} onClick={() => setGroupBy(unit)} className={`px-3 py-1 text-sm rounded-md capitalize ${groupBy === unit ? 'bg-green-500 text-white' : 'bg-gray-200'}`}>
                                {unit}s
                            </button>
                        ))}
                    </div>
                    <div className="h-80 md:h-96">
                        <canvas ref={chartRef}></canvas>
                    </div>
                </div>
            );
        };

        const ListView = ({ increments, onIncrementDeleteRequest, onIncrementEditRequest }) => {
            const groupedIncrements = useMemo(() => {
                const groups = {};
                const sorted = [...increments].sort((a, b) => b.timestamp - a.timestamp);
                sorted.forEach(inc => {
                    const d = new Date(inc.timestamp);
                    const year = d.getFullYear();
                    const month = d.toLocaleString('default', { month: 'long' });
                    const yearMonth = `${month} ${year}`;
                    if (!groups[yearMonth]) {
                        groups[yearMonth] = [];
                    }
                    groups[yearMonth].push(inc);
                });
                return groups;
            }, [increments]);

            return (
                <div className="max-h-96 overflow-y-auto space-y-4 pr-2">
                    {Object.entries(groupedIncrements).map(([groupTitle, groupIncrements]) => (
                        <div key={groupTitle}>
                            <h3 className="text-lg font-bold text-gray-700 mb-2 border-b pb-1">{groupTitle}</h3>
                            <div className="space-y-2">
                                {groupIncrements.map(inc => (
                                    <div key={inc.id} className="bg-gray-100 p-3 rounded-md flex justify-between items-center">
                                        <div>
                                            <span className="font-semibold">{new Date(inc.timestamp).toLocaleDateString(undefined, { weekday: 'long', day: 'numeric' })}</span>
                                            <span className="text-gray-600 ml-4">{new Date(inc.timestamp).toLocaleTimeString()}</span>
                                        </div>
                                        <div className="flex items-center">
                                            <button onClick={() => onIncrementEditRequest(inc)} className="text-gray-500 hover:text-blue-700 w-8 h-8 flex items-center justify-center rounded-full hover:bg-blue-100 transition-colors" aria-label="Edit this entry">
                                                <svg className="w-5 h-5" fill="currentColor" viewBox="0 0 20 20"><path d="M17.414 2.586a2 2 0 00-2.828 0L7 10.172V13h2.828l7.586-7.586a2 2 0 000-2.828z"></path><path fillRule="evenodd" d="M2 6a2 2 0 012-2h4a1 1 0 010 2H4v10h10v-4a1 1 0 112 0v4a2 2 0 01-2 2H4a2 2 0 01-2-2V6z" clipRule="evenodd"></path></svg>
                                            </button>
                                            <button onClick={() => onIncrementDeleteRequest(inc)} className="text-red-500 font-bold text-xl hover:text-red-700 w-8 h-8 flex items-center justify-center rounded-full hover:bg-red-100 transition-colors" aria-label="Delete this entry">
                                                &times;
                                            </button>
                                        </div>
                                    </div>
                                ))}
                            </div>
                        </div>
                    ))}
                </div>
            );
        };

        const CalendarView = ({ increments, onDayUpdate }) => {
            const [currentDate, setCurrentDate] = useState(new Date());
            const [tooltip, setTooltip] = useState({ visible: false, x: 0, y: 0, content: [] });
            const [dayActionModal, setDayActionModal] = useState({ visible: false, date: null });

            const incrementsByDay = useMemo(() => {
                return increments.reduce((acc, inc) => {
                    const dayStart = new Date(new Date(inc.timestamp).setHours(0,0,0,0)).getTime();
                    if (!acc[dayStart]) acc[dayStart] = [];
                    acc[dayStart].push(inc);
                    return acc;
                }, {});
            }, [increments]);
            
            const handleDayHover = (e, dayIncrements) => {
                if (dayIncrements.length > 0) {
                    const rect = e.target.getBoundingClientRect();
                    setTooltip({
                        visible: true,
                        x: rect.left + rect.width / 2,
                        y: rect.top,
                        content: dayIncrements.map(inc => new Date(inc.timestamp).toLocaleTimeString())
                    });
                }
            };
            
            const handleDayClick = (date) => {
                setDayActionModal({ visible: true, date });
            };

            const handleOverride = (newCount) => {
                const newIncrements = Array.from({ length: newCount }, (_, i) => ({
                    id: Date.now() + i,
                    timestamp: dayActionModal.date.getTime() + 12 * 3600 * 1000 // Noon
                }));
                onDayUpdate(dayActionModal.date, newIncrements);
                setDayActionModal({ visible: false, date: null });
            };

            const handleReset = () => {
                onDayUpdate(dayActionModal.date, []);
                setDayActionModal({ visible: false, date: null });
            };

            const year = currentDate.getFullYear();
            const month = currentDate.getMonth();
            const firstDayOfMonth = new Date(year, month, 1).getDay();
            const daysInMonth = new Date(year, month + 1, 0).getDate();
            const dayHeaders = ['Sun', 'Mon', 'Tue', 'Wed', 'Thu', 'Fri', 'Sat'];

            return (
                <>
                    {tooltip.visible && ReactDOM.createPortal(
                        <div className="tooltip" style={{ left: tooltip.x, top: tooltip.y }}>
                            <ul className="list-none p-0 m-0">{tooltip.content.map((time, i) => <li key={i}>{time}</li>)}</ul>
                        </div>,
                        document.body
                    )}
                    {dayActionModal.visible && (
                        <DayActionModal 
                            date={dayActionModal.date}
                            onClose={() => setDayActionModal({ visible: false, date: null })}
                            onOverride={handleOverride}
                            onReset={handleReset}
                        />
                    )}
                    <div className="p-4 border rounded-lg">
                        <div className="flex justify-between items-center mb-4">
                            <button onClick={() => setCurrentDate(new Date(year, month - 1, 1))} className="px-3 py-1 rounded bg-gray-200 hover:bg-gray-300">&lt;</button>
                            <h3 className="font-bold text-lg">{currentDate.toLocaleString('default', { month: 'long', year: 'numeric' })}</h3>
                            <button onClick={() => setCurrentDate(new Date(year, month + 1, 1))} className="px-3 py-1 rounded bg-gray-200 hover:bg-gray-300">&gt;</button>
                        </div>
                        <div className="calendar-grid">
                            {dayHeaders.map(day => <div key={day} className="calendar-day-header text-center font-semibold">{day}</div>)}
                            {Array.from({ length: firstDayOfMonth }).map((_, i) => <div key={`empty-${i}`} />)}
                            {Array.from({ length: daysInMonth }).map((_, day) => {
                                const dayNumber = day + 1;
                                const date = new Date(year, month, dayNumber);
                                const dayTime = date.getTime();
                                const dayIncrements = incrementsByDay[dayTime] || [];
                                const isMarked = dayIncrements.length > 0;
                                return (
                                    <div key={dayNumber} className={`calendar-day flex items-center justify-center cursor-pointer ${isMarked ? 'marked-day' : ''}`}
                                        onMouseEnter={(e) => handleDayHover(e, dayIncrements)}
                                        onMouseLeave={() => setTooltip({ visible: false, x: 0, y: 0, content: [] })}
                                        onClick={() => handleDayClick(date)}
                                    >
                                        {dayNumber}
                                    </div>
                                );
                            })}
                        </div>
                    </div>
                </>
            );
        };

        const DayActionModal = ({ date, onClose, onOverride, onReset }) => {
            const [count, setCount] = useState('');
            const handleSubmit = (e) => {
                e.preventDefault();
                const num = parseInt(count, 10);
                if (!isNaN(num) && num >= 0) onOverride(num);
            };
            return (
                <div className="fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center z-50" onClick={onClose}>
                    <div className="bg-white p-8 rounded-lg shadow-xl w-full max-w-sm" onClick={e => e.stopPropagation()}>
                        <h2 className="text-2xl font-bold mb-2">Actions for {date.toLocaleDateString()}</h2>
                        <form onSubmit={handleSubmit} className="mb-4">
                            <label className="block text-sm font-medium text-gray-700 mb-1">Override Count for this Day</label>
                            <div className="flex gap-2">
                                <input type="number" value={count} onChange={(e) => setCount(e.target.value)} placeholder="New count" className="w-full p-2 border rounded-lg focus:ring-2 focus:ring-green-500 focus:outline-none" autoFocus />
                                <button type="submit" className="px-4 py-2 bg-yellow-500 text-white rounded-lg hover:bg-yellow-600">Set</button>
                            </div>
                        </form>
                        <button onClick={onReset} className="w-full px-4 py-2 bg-red-500 text-white rounded-lg hover:bg-red-600">Reset Day to 0</button>
                        <button onClick={onClose} className="w-full mt-4 px-4 py-2 bg-gray-200 rounded-lg hover:bg-gray-300">Cancel</button>
                    </div>
                </div>
            );
        };

        const ConfirmationModal = ({ onConfirm, onCancel, title, message }) => {
            return (
                <div className="fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center z-50" onClick={onCancel}>
                    <div className="bg-white p-8 rounded-lg shadow-xl w-full max-w-sm" onClick={e => e.stopPropagation()}>
                        <h2 className="text-2xl font-bold mb-2">{title}</h2>
                        <p className="text-gray-600 mb-6">{message}</p>
                        <div className="flex justify-end gap-3">
                            <button onClick={onCancel} className="px-4 py-2 bg-gray-200 rounded-lg hover:bg-gray-300">Cancel</button>
                            <button onClick={onConfirm} className="px-4 py-2 bg-red-500 text-white rounded-lg hover:bg-red-600">Delete</button>
                        </div>
                    </div>
                </div>
            );
        };
        
        const ExportModal = ({ event, increments, onClose, setToast }) => {
            const handleExportCSV = () => {
                let csvContent = "data:text/csv;charset=utf-8,";
                csvContent += "Event,TimestampISO\r\n"; // Header
                increments.forEach(inc => {
                    const d = new Date(inc.timestamp);
                    const eventNameQuoted = `"${event.name.replace(/"/g, '""')}"`;
                    const row = [eventNameQuoted, d.toISOString()].join(",");
                    csvContent += row + "\r\n";
                });

                const encodedUri = encodeURI(csvContent);
                const link = document.createElement("a");
                link.setAttribute("href", encodedUri);
                link.setAttribute("download", `${event.name.replace(/\s+/g, '_')}_export.csv`);
                document.body.appendChild(link);
                link.click();
                document.body.removeChild(link);
                onClose();
            };

            const handleCopyToSheets = () => {
                let tsvContent = "Event\tTimestampISO\r\n"; // Header with tabs
                increments.forEach(inc => {
                    const d = new Date(inc.timestamp);
                    const row = [event.name, d.toISOString()].join("\t");
                    tsvContent += row + "\r\n";
                });
                
                const textArea = document.createElement("textarea");
                textArea.value = tsvContent;
                textArea.style.position = "fixed";
                textArea.style.top = "0";
                textArea.style.left = "0";
                textArea.style.width = "2em";
                textArea.style.height = "2em";
                textArea.style.padding = "0";
                textArea.style.border = "none";
                textArea.style.outline = "none";
                textArea.style.boxShadow = "none";
                textArea.style.background = "transparent";
                document.body.appendChild(textArea);
                textArea.focus();
                textArea.select();

                try {
                    const successful = document.execCommand('copy');
                    if (successful) {
                        setToast("Data copied to clipboard. Paste into Google Sheets.");
                        window.open('https://sheets.new', '_blank');
                    } else {
                        setToast("Failed to copy data.");
                    }
                } catch (err) {
                    console.error('Could not copy text: ', err);
                    setToast("Failed to copy data.");
                }

                document.body.removeChild(textArea);
                onClose();
            };

            return (
                <div className="fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center z-50" onClick={onClose}>
                    <div className="bg-white p-8 rounded-lg shadow-xl w-full max-w-sm" onClick={e => e.stopPropagation()}>
                        <h2 className="text-2xl font-bold mb-4">Export Data</h2>
                        <div className="space-y-3">
                            <button onClick={handleExportCSV} className="w-full px-4 py-3 bg-green-500 text-white rounded-lg hover:bg-green-600 font-semibold">Download as CSV</button>
                            <button onClick={handleCopyToSheets} className="w-full px-4 py-3 bg-blue-500 text-white rounded-lg hover:bg-blue-600 font-semibold">Copy for Google Sheets</button>
                        </div>
                        <button onClick={onClose} className="w-full mt-6 px-4 py-2 bg-gray-200 rounded-lg hover:bg-gray-300">Cancel</button>
                    </div>
                </div>
            );
        };

        const ImportModal = ({ onClose, onImport }) => {
            const handleFileChange = (event) => {
                const file = event.target.files[0];
                if (file) {
                    const reader = new FileReader();
                    reader.onload = (e) => {
                        onImport(e.target.result);
                    };
                    reader.readAsText(file);
                }
            };

            return (
                <div className="fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center z-50" onClick={onClose}>
                    <div className="bg-white p-8 rounded-lg shadow-xl w-full max-w-sm" onClick={e => e.stopPropagation()}>
                        <h2 className="text-2xl font-bold mb-4">Import from CSV</h2>
                        <p className="text-gray-600 mb-4">Select a CSV file with the columns: "Event", "TimestampISO".</p>
                        <input
                            type="file"
                            accept=".csv"
                            onChange={handleFileChange}
                            className="w-full p-2 border rounded-lg"
                        />
                        <button onClick={onClose} className="w-full mt-6 px-4 py-2 bg-gray-200 rounded-lg hover:bg-gray-300">Cancel</button>
                    </div>
                </div>
            );
        };
        
        const EditNameModal = ({ currentName, onClose, onSave }) => {
            const [newName, setNewName] = useState(currentName);
            const handleSubmit = (e) => {
                e.preventDefault();
                if (newName.trim()) {
                    onSave(newName.trim());
                }
            };
            return (
                 <div className="fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center z-50" onClick={onClose}>
                    <div className="bg-white p-8 rounded-lg shadow-xl w-full max-w-sm" onClick={e => e.stopPropagation()}>
                        <h2 className="text-2xl font-bold mb-4">Edit Name</h2>
                        <form onSubmit={handleSubmit}>
                            <input
                                type="text"
                                value={newName}
                                onChange={(e) => setNewName(e.target.value)}
                                className="w-full p-2 border rounded-lg mb-4"
                                autoFocus
                            />
                            <div className="flex justify-end gap-3">
                                <button type="button" onClick={onClose} className="px-4 py-2 bg-gray-200 rounded-lg hover:bg-gray-300">Cancel</button>
                                <button type="submit" className="px-4 py-2 bg-green-500 text-white rounded-lg hover:bg-green-600">Save</button>
                            </div>
                        </form>
                    </div>
                </div>
            );
        };

        const EditIncrementModal = ({ increment, onClose, onSave }) => {
            const [dateValue, setDateValue] = useState('');
            const [timeValue, setTimeValue] = useState('');

            useEffect(() => {
                if (increment) {
                    const d = new Date(increment.timestamp);
                    setDateValue(d.toISOString().split('T')[0]); // YYYY-MM-DD
                    setTimeValue(d.toTimeString().split(' ')[0].substring(0, 5)); // HH:MM
                }
            }, [increment]);

            const handleSubmit = (e) => {
                e.preventDefault();
                const newTimestamp = new Date(`${dateValue}T${timeValue}`).getTime();
                if (!isNaN(newTimestamp)) {
                    onSave({ ...increment, timestamp: newTimestamp });
                }
            };
            
            if (!increment) return null;

            return (
                 <div className="fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center z-50" onClick={onClose}>
                    <div className="bg-white p-8 rounded-lg shadow-xl w-full max-w-sm" onClick={e => e.stopPropagation()}>
                        <h2 className="text-2xl font-bold mb-4">Edit Trigger Time</h2>
                        <form onSubmit={handleSubmit}>
                            <div className="mb-4">
                                <label className="block text-sm font-medium text-gray-700 mb-1">Date</label>
                                <input type="date" value={dateValue} onChange={e => setDateValue(e.target.value)} className="w-full p-2 border rounded-lg" />
                            </div>
                            <div className="mb-4">
                                <label className="block text-sm font-medium text-gray-700 mb-1">Time</label>
                                <input type="time" value={timeValue} onChange={e => setTimeValue(e.target.value)} className="w-full p-2 border rounded-lg" />
                            </div>
                            <div className="flex justify-end gap-3">
                                <button type="button" onClick={onClose} className="px-4 py-2 bg-gray-200 rounded-lg hover:bg-gray-300">Cancel</button>
                                <button type="submit" className="px-4 py-2 bg-green-500 text-white rounded-lg hover:bg-green-600">Save</button>
                            </div>
                        </form>
                    </div>
                </div>
            );
        };

        const root = ReactDOM.createRoot(document.getElementById('root'));
        root.render(<App />);
    </script>
    <script>
        if ('serviceWorker' in navigator && (window.location.protocol === 'http:' || window.location.protocol === 'https:')) {
            window.addEventListener('load', () => {
                navigator.serviceWorker.register('./service-worker.js').catch(err => console.error('SW registration failed:', err));
            });
        }
    </script>
</body>
</html>
